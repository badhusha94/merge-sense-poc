# Human-in-the-loop: comment /ai-apply-refactor on a PR to apply AI refactors.
# The "apply" job uses environment "refactor-approval" so a human must approve before code is changed.
# After apply: commits + pushes to the PR branch, then checks re-run; developer is asked to test before merge.

name: AI Apply Refactor

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: read
  issues: write
  actions: write

jobs:
  detect:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request != null && contains(github.event.comment.body, '/ai-apply-refactor')
    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      head_ref: ${{ steps.pr.outputs.head_ref }}
    steps:
      - name: Get PR head ref
        id: pr
        run: |
          PR_JSON=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}")
          echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          HEAD_REF=$(echo "$PR_JSON" | jq -r '.head.ref')
          echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT

  apply:
    runs-on: ubuntu-latest
    needs: detect
    environment: refactor-approval
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.detect.outputs.head_ref }}
          fetch-depth: 0

      - name: Ensure apply-refactor script exists (use main if missing)
        run: |
          if [ ! -f ai-reviewer/apply-refactor.js ]; then
            git fetch origin main 2>/dev/null || true
            git show origin/main:ai-reviewer/apply-refactor.js > ai-reviewer/apply-refactor.js 2>/dev/null || true
          fi
          test -f ai-reviewer/apply-refactor.js || (echo "apply-refactor.js not found on this branch or main" && exit 1)

      - name: Configure git for push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

      - name: Get diff vs main
        run: |
          git fetch origin main 2>/dev/null || true
          git diff origin/main...HEAD -- "modern-app/api/**" > pr.diff || true
          echo "PR_DIFF_FILE=${{ github.workspace }}/pr.diff" >> $GITHUB_ENV

      - name: Extract C# from main branch
        run: |
          touch main_code.cs
          for f in $(git ls-tree -r origin/main --name-only 2>/dev/null | grep '\.cs$' | grep 'modern-app/api/'); do
            git show "origin/main:$f" 2>/dev/null >> main_code.cs || true
          done
          echo "MAIN_CODE_FILE=${{ github.workspace }}/main_code.cs" >> $GITHUB_ENV

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ai-reviewer dependencies
        working-directory: ai-reviewer
        run: npm ci || npm install

      - name: Run AI review (get current findings)
        working-directory: ai-reviewer
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          PR_DIFF_FILE: ${{ env.PR_DIFF_FILE }}
          MAIN_CODE_FILE: ${{ env.MAIN_CODE_FILE }}
          FINDINGS_OUTPUT: ${{ github.workspace }}/findings.json
        run: node analyze.js

      - name: Apply AI refactor (commit + push)
        working-directory: ai-reviewer
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          PR_NUMBER: ${{ needs.detect.outputs.pr_number }}
          PR_HEAD_REF: ${{ needs.detect.outputs.head_ref }}
          FINDINGS_OUTPUT: ${{ github.workspace }}/findings.json
          PR_DIFF_FILE: ${{ github.workspace }}/pr.diff
        run: node apply-refactor.js

      - name: Trigger AI Semantic Review (workflow_dispatch)
        shell: bash
        run: |
          set -euo pipefail
          # The bot push done via GITHUB_TOKEN may not trigger pull_request workflows automatically.
          # Explicitly dispatch the review workflow on the PR branch so the required check runs.
          curl -sS -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/ai-review.yml/dispatches" \
            -d '{"ref":"${{ needs.detect.outputs.head_ref }}"}'
